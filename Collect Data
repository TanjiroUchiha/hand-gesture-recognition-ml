import cv2
import mediapipe as mp
import csv
import os

mp_draw = mp.solutions.drawing_utils
mp_hands = mp.solutions.hands
hands = mp_hands.Hands(max_num_hands=1)
cap = cv2.VideoCapture(0)

gesture_name = input("Enter gesture name: ")
os.makedirs("data", exist_ok=True)
file_path = f"data/{gesture_name}.csv"

with open(file_path, "w", newline="") as f:
    writer = csv.writer(f)
    count = 0
    print("Show the gesture and press 's' to start saving...")

    while True:
        ret, frame = cap.read()
        frame = cv2.flip(frame, 1)
        img_rgb = cv2.cvtColor(frame, cv2.COLOR_BGR2RGB)
        results = hands.process(img_rgb)

        if results.multi_hand_landmarks:
            for hand_landmarks in results.multi_hand_landmarks:
                mp_draw.draw_landmarks(frame, hand_landmarks, mp_hands.HAND_CONNECTIONS)

        cv2.putText(frame, f"Gesture: {gesture_name} | Saved: {count}", (10, 30),
                    cv2.FONT_HERSHEY_SIMPLEX, 1, (0, 255, 0), 2)
        cv2.imshow("Collecting Data", frame)

        key = cv2.waitKey(1)
        if key & 0xFF == ord('s'):  #Press s to start capturing
            if results.multi_hand_landmarks:
                for hand_landmarks in results.multi_hand_landmarks:
                    data = []
                    for lm in hand_landmarks.landmark:
                        data.extend([lm.x, lm.y])
                    writer.writerow(data)
                    count += 1
                    print(f"Saved frame {count}")

        elif key & 0xFF == ord('q'):  #Press q to exit
            break

cap.release()
cv2.destroyAllWindows()
print(f"Data collection finished for {gesture_name}. File saved as {file_path}")
